<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Client-Side OCR (Preprocessed, No Worker)</title>
<!-- Use a stable Tesseract.js build -->
<script src="https://unpkg.com/tesseract.js@v2.1.4/dist/tesseract.min.js"></script>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }
  h1 {
    margin-bottom: 0.5rem;
  }
  #preview {
    max-width: 300px;
    max-height: 300px;
    margin-top: 10px;
    border: 1px solid #ccc;
    object-fit: contain;
    display: block;
  }
  #text {
    width: 100%;
    height: 250px;
    margin-top: 15px;
    box-sizing: border-box;
  }
  #status {
    margin-top: 10px;
    color: #555;
    font-size: 0.9rem;
  }
</style>
</head>
<body>

<h1>Image to Text (Client-Side OCR)</h1>

<input type="file" id="fileInput" accept="image/*" />
<br />
<img id="preview" alt="Preview will appear here" />
<div id="status"></div>
<textarea id="text" placeholder="Recognized text will appear here..."></textarea>

<!-- Hidden canvas for preprocessing -->
<canvas id="canvas" style="display:none;"></canvas>

<script>
  const fileInput = document.getElementById('fileInput');
  const preview   = document.getElementById('preview');
  const statusEl  = document.getElementById('status');
  const textArea  = document.getElementById('text');
  const canvas    = document.getElementById('canvas');
  const ctx       = canvas.getContext('2d');

  fileInput.addEventListener('change', handleFileChange);

  function handleFileChange(e) {
    const file = e.target.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    preview.src = url;
    statusEl.textContent = 'Loading image…';
    textArea.value = '';

    const img = new Image();
    img.onload = async () => {
      try {
        // ---- Resize / scale image ----
        const maxWidth = 1500;
        const scale = img.width > maxWidth ? maxWidth / img.width : 1;
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);

        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);

        // ---- Grayscale + binary threshold ----
        statusEl.textContent = 'Preprocessing image…';
        const imgData = ctx.getImageData(0, 0, w, h);
        const data = imgData.data;
        const threshold = 160; // you can tweak this

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const v = 0.299 * r + 0.587 * g + 0.114 * b; // luminance
          const bw = v < threshold ? 0 : 255;
          data[i]     = bw; // R
          data[i + 1] = bw; // G
          data[i + 2] = bw; // B
          // data[i + 3] is alpha; leave as-is
        }
        ctx.putImageData(imgData, 0, 0);

        // ---- OCR on the preprocessed canvas ----
        statusEl.textContent = 'Running OCR…';

        const result = await Tesseract.recognize(
          canvas,
          'eng',
          {
            logger: m => {
              if (m && m.status && typeof m.progress === 'number') {
                statusEl.textContent = `${m.status} (${Math.round(m.progress * 100)}%)`;
              }
            }
          }
        );

        textArea.value = result.data && result.data.text ? result.data.text : '';
        statusEl.textContent = 'Done.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error during OCR. Check console for details.';
      } finally {
        URL.revokeObjectURL(url);
      }
    };

    img.onerror = () => {
      statusEl.textContent = 'Could not load image.';
      URL.revokeObjectURL(url);
    };

    img.src = url;
  }
</script>

</body>
</html> 
